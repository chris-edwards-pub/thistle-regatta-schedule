{% extends "base.html" %}
{% block content %}

<div class="mb-3 d-flex gap-2">
    {% if current_user.is_admin %}
    <a href="{{ url_for('regattas.create') }}" class="btn btn-primary btn-sm">+ Add Regatta</a>
    {% endif %}
    <a href="{{ url_for('regattas.pdf') }}" class="btn btn-outline-secondary btn-sm no-print" target="_blank">Print PDF</a>
</div>

{% macro regatta_table(regattas, is_past, table_id) %}
{% if current_user.is_admin %}
<form method="POST" action="{{ url_for('regattas.bulk_delete') }}" id="{{ table_id }}-form" onsubmit="return confirmBulkDelete(this)">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>
{% endif %}
<div class="table-responsive">
    <table class="table table-hover align-middle{% if is_past %} regatta-past{% endif %}">
        <thead>
            <tr>
                <th>Date(s)</th>
                <th>Class</th>
                <th>Regatta</th>
                <th>Location</th>
                <th class="text-nowrap">Docs</th>
                <th class="text-nowrap">Crew</th>
                {% if not is_past %}
                <th>Your RSVP</th>
                {% endif %}
                {% if current_user.is_admin %}
                <th>Edit</th>
                <th><input type="checkbox" class="select-all" data-table="{{ table_id }}"></th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for regatta in regattas %}
            <tr>
                <td class="text-nowrap">
                    {{ regatta.start_date.strftime('%b %d') }}{% if regatta.end_date %} – {{ regatta.end_date.strftime('%b %d') }}{% endif %}, {{ regatta.start_date.strftime('%Y') }}
                </td>
                <td>{{ regatta.boat_class }}</td>
                <td>
                    <strong>{{ regatta.name }}</strong>
                    {% if regatta.notes %}
                    <br><small class="text-muted">{{ regatta.notes }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if regatta.location_url %}
                    <a href="{{ regatta.location_url }}" target="_blank" class="location-link">{{ regatta.location }}</a>
                    {% else %}
                    {{ regatta.location }}
                    {% endif %}
                </td>
                <td class="text-nowrap">
                    {% for doc in regatta.documents|sort(attribute='doc_type') %}
                    <a href="{% if doc.url %}{{ doc.url }}{% else %}{{ url_for('regattas.download_doc', doc_id=doc.id) }}{% endif %}" class="badge bg-info text-decoration-none doc-link" target="_blank">{{ doc.doc_type }}</a>
                    {% endfor %}
                </td>
                <td>
                    {% for rsvp in regatta.rsvps|sort_rsvps %}
                    <a href="{{ url_for('auth.view_profile', user_id=rsvp.user.id) }}" class="crew-badge {{ rsvp.status }}" title="{{ rsvp.user.display_name }}">{% if rsvp.status == 'yes' %}&#10003;{% elif rsvp.status == 'no' %}&#10007;{% elif rsvp.status == 'maybe' %}?{% endif %} {{ rsvp.user.initials }}</a>
                    {% endfor %}
                </td>
                {% if not is_past %}
                <td>
                    <form method="POST" action="{{ url_for('regattas.rsvp', regatta_id=regatta.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        {% set my_rsvp = regatta.rsvps.filter_by(user_id=current_user.id).first() %}
                        <select name="status" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
                            <option value="" {% if not my_rsvp %}selected{% endif %}>—</option>
                            <option value="yes" {% if my_rsvp and my_rsvp.status == 'yes' %}selected{% endif %}>Yes</option>
                            <option value="no" {% if my_rsvp and my_rsvp.status == 'no' %}selected{% endif %}>No</option>
                            <option value="maybe" {% if my_rsvp and my_rsvp.status == 'maybe' %}selected{% endif %}>Maybe</option>
                        </select>
                    </form>
                </td>
                {% endif %}
                {% if current_user.is_admin %}
                <td>
                    <a href="{{ url_for('regattas.edit', regatta_id=regatta.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
                </td>
                <td>
                    <input type="checkbox" name="selected" value="{{ regatta.id }}" form="{{ table_id }}-form">
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if current_user.is_admin %}
<div class="text-end">
    <button type="submit" form="{{ table_id }}-form" class="btn btn-sm btn-outline-danger">Delete Selected</button>
</div>
{% endif %}
{% endmacro %}

{% if upcoming %}
<h5>Upcoming</h5>
{{ regatta_table(upcoming, false, "upcoming") }}
{% else %}
<p class="text-muted">No upcoming regattas. {% if current_user.is_admin %}Add one!{% endif %}</p>
{% endif %}

{% if past %}
<h5 class="mt-4">Past</h5>
{{ regatta_table(past, true, "past") }}
{% endif %}

{% if current_user.is_admin %}
<script>
document.querySelectorAll('.select-all').forEach(function(cb) {
    cb.addEventListener('change', function() {
        var formId = this.dataset.table + '-form';
        document.querySelectorAll('input[name="selected"][form="' + formId + '"]').forEach(function(box) {
            box.checked = cb.checked;
        });
    });
});

function confirmBulkDelete(form) {
    var formId = form.id;
    var count = document.querySelectorAll('input[name="selected"][form="' + formId + '"]:checked').length;
    if (count === 0) {
        alert('No regattas selected.');
        return false;
    }
    return confirm('Delete ' + count + ' selected regatta(s)?');
}
</script>
{% endif %}
{% endblock %}
