{% extends "base.html" %}
{% block content %}
{% if current_user.is_admin %}
<div class="mb-3">
    <a href="{{ url_for('regattas.create') }}" class="btn btn-primary btn-sm">+ Add Regatta</a>
</div>
{% endif %}

{% macro regatta_table(regattas, is_past) %}
<div class="table-responsive">
    <table class="table table-hover align-middle{% if is_past %} regatta-past{% endif %}">
        <thead>
            <tr>
                <th>Date</th>
                <th>Regatta</th>
                <th>Location</th>
                <th>Docs</th>
                <th>Crew</th>
                {% if not is_past %}
                <th>Your RSVP</th>
                {% endif %}
                {% if current_user.is_admin %}
                <th></th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for regatta in regattas %}
            <tr>
                <td class="text-nowrap">
                    {{ regatta.start_date.strftime('%b %d') }}{% if regatta.end_date %} – {{ regatta.end_date.strftime('%b %d') }}{% endif %}, {{ regatta.start_date.strftime('%Y') }}
                </td>
                <td>
                    <strong>{{ regatta.name }}</strong>
                    {% if regatta.notes %}
                    <br><small class="text-muted">{{ regatta.notes }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if regatta.location_url %}
                    <a href="{{ regatta.location_url }}" target="_blank">{{ regatta.location }}</a>
                    {% else %}
                    {{ regatta.location }}
                    {% endif %}
                </td>
                <td>
                    {% for doc in regatta.documents %}
                    <a href="{{ url_for('regattas.download_doc', doc_id=doc.id) }}" class="badge bg-info text-decoration-none doc-link">{{ doc.doc_type }}</a>
                    {% endfor %}
                </td>
                <td>
                    {% for rsvp in regatta.rsvps %}
                    <span class="crew-badge {{ rsvp.status }}" title="{{ rsvp.user.display_name }}: {{ rsvp.status }}">{{ rsvp.user.initials }}</span>
                    {% endfor %}
                </td>
                {% if not is_past %}
                <td>
                    <form method="POST" action="{{ url_for('regattas.rsvp', regatta_id=regatta.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        {% set my_rsvp = regatta.rsvps.filter_by(user_id=current_user.id).first() %}
                        <select name="status" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
                            <option value="" {% if not my_rsvp %}selected{% endif %}>—</option>
                            <option value="yes" {% if my_rsvp and my_rsvp.status == 'yes' %}selected{% endif %}>Yes</option>
                            <option value="no" {% if my_rsvp and my_rsvp.status == 'no' %}selected{% endif %}>No</option>
                            <option value="maybe" {% if my_rsvp and my_rsvp.status == 'maybe' %}selected{% endif %}>Maybe</option>
                        </select>
                    </form>
                </td>
                {% endif %}
                {% if current_user.is_admin %}
                <td class="text-nowrap">
                    <a href="{{ url_for('regattas.edit', regatta_id=regatta.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
                    <form method="POST" action="{{ url_for('regattas.delete', regatta_id=regatta.id) }}" class="d-inline" onsubmit="return confirm('Delete this regatta?')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Del</button>
                    </form>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endmacro %}

{% if upcoming %}
<h5>Upcoming</h5>
{{ regatta_table(upcoming, false) }}
{% else %}
<p class="text-muted">No upcoming regattas. {% if current_user.is_admin %}Add one!{% endif %}</p>
{% endif %}

{% if past %}
<h5 class="mt-4">Past</h5>
{{ regatta_table(past, true) }}
{% endif %}
{% endblock %}
